from unittest import TestCase
import pytest
import json
from django.contrib.gis.geos import Point
from django.contrib.gis.geos import GEOSGeometry
from api.models import (
    BusStop, Location, TrainStop, Substation, OverheadLine, Motorway)


class TestBusStopModel(TestCase):
    @pytest.mark.django_db
    def test_update_location_no_busstop(self):
        busstop = BusStop()
        busstop.name = 'Test BusStop'
        busstop.point = Point(-2.347743000012108, 53.38737090322739)
        busstop.save()

        location = Location()
        location.name = 'Test Location'
        geometry = """
            {"coordinates": [
                [
                    [
                        [-2.373605477415186, 53.40969504659278],
                        [-2.3737618172100063, 53.409339507361864],
                        [-2.3736420825281206, 53.409349059663356],
                        [-2.3736136182503316, 53.40925098435937],
                        [-2.372348437061216, 53.40941673318565],
                        [-2.3723238976272407, 53.409362878222495],
                        [-2.371773640845859, 53.40943257437743],
                        [-2.3718032009919567, 53.40951191448939],
                        [-2.3718245008682466, 53.40956909854221],
                        [-2.3718353336832725, 53.4095981768949],
                        [-2.372388619083221, 53.40952876960275],
                        [-2.372366986029961, 53.40974214341905],
                        [-2.37244330450709, 53.40977355411032],
                        [-2.3724480893933726, 53.40980293194619],
                        [-2.3730546640198655, 53.40984058711081],
                        [-2.3730816588728425, 53.409842195613976],
                        [-2.373519931021509, 53.40988946797718],
                        [-2.3736042816221192, 53.409901787986364],
                        [-2.3736898279409133, 53.40970736641803],
                        [-2.373605477415186, 53.40969504659278]
                    ]
                ]
            ],
            "type": "MultiPolygon"}
        """
        location.geom = GEOSGeometry(geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        busstop.update_close_locations(default_range=3000)

        updated_location = Location.objects.first()
        self.assertEqual(
            updated_location.nearest_busstop.name,
            'Test BusStop')
        self.assertIsNotNone(updated_location.nearest_busstop_distance)


class TestLocationModel(TestCase):
    @pytest.mark.django_db
    def test_update_nearest_busstop_on_new_location(self):
        busstop = BusStop()
        busstop.name = 'Test BusStop'
        busstop.point = Point(-2.4153695332751557, 53.585971152959274)
        busstop.save()

        location = Location()
        location.name = 'Test Location'
        geometry = """
            {"coordinates": [
                [
                    [
                        [-2.417243587559938, 53.587307594998805],
                        [-2.4172773190316676, 53.587280070692486],
                        [-2.4173514409852657, 53.58721825948106],
                        [-2.4173514409852657, 53.58721825948106],
                        [-2.417384428573676, 53.58719109717106],
                        [-2.417386408047504, 53.58718974239604],
                        [-2.417388763821763, 53.58718865588064],
                        [-2.417391496782378, 53.58718792747945],
                        [-2.417394356948235, 53.58718746820736],
                        [-2.417397345205334, 53.587187367918965],
                        [-2.417400337006054, 53.587187627048955],
                        [-2.4174030832552806, 53.587188246466916],
                        [-2.4174057076147375, 53.58718913588342],
                        [-2.4174557446310443, 53.587211066209946],
                        [-2.417457873460361, 53.587212226928386],
                        [-2.4174596313048182, 53.587213658515026],
                        [-2.417460892730692, 53.58721527155018],
                        [-2.417461656851856, 53.58721697617914],
                        [-2.417461798234508, 53.58721868298221],
                        [-2.417461442312349, 53.587220481379084],
                        [-2.4174603373317, 53.587222102675575],
                        [-2.4174588578217557, 53.58722363542186],
                        [-2.417425864940114, 53.58725025862445],
                        [-2.417425864940114, 53.58725025862445],
                        [-2.4173494967466667, 53.58731162843292],
                        [-2.4173157608682145, 53.58733870348632],
                        [-2.4173137804994558, 53.58733996840554],
                        [-2.4173114247148657, 53.58734105491944],
                        [-2.4173088162910576, 53.58734178288413],
                        [-2.417305956113853, 53.58734224215419],
                        [-2.4173029678456346, 53.58734234244034],
                        [-2.4173001005826373, 53.58734208287329],
                        [-2.417297355210633, 53.58734155330762],
                        [-2.417294730843975, 53.58734066388879],
                        [-2.417246949791007, 53.58732016334699],
                        [-2.417244820961996, 53.58731900262481],
                        [-2.4172429385723864, 53.58731757146959],
                        [-2.4172416771517287, 53.58731595843215],
                        [-2.417240913037613, 53.587314253801786],
                        [-2.41724077166351, 53.58731254699851],
                        [-2.4172411275957963, 53.587310748602285],
                        [-2.417242107153561, 53.58730903788777],
                        [-2.417243587559938, 53.587307594998805]
                    ]
                ]
            ],
            "type": "MultiPolygon"}
        """

        location.geom = GEOSGeometry(geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        saved_location = Location.objects.first()

        self.assertIsNotNone(saved_location.nearest_busstop)
        self.assertTrue(saved_location.nearest_busstop_distance > 0)

    @pytest.mark.django_db
    def test_busstop_pre_delete_signal(self):
        busstop = BusStop()
        busstop.name = 'Test BusStop'
        busstop.point = Point(-2.347743000012108, 53.38737090322739)
        busstop.save()

        location = Location()
        location.name = 'Test Location'
        geometry = """
            {"coordinates": [
                [
                    [
                        [-2.373605477415186, 53.40969504659278],
                        [-2.3737618172100063, 53.409339507361864],
                        [-2.3736420825281206, 53.409349059663356],
                        [-2.3736136182503316, 53.40925098435937],
                        [-2.372348437061216, 53.40941673318565],
                        [-2.3723238976272407, 53.409362878222495],
                        [-2.371773640845859, 53.40943257437743],
                        [-2.3718032009919567, 53.40951191448939],
                        [-2.3718245008682466, 53.40956909854221],
                        [-2.3718353336832725, 53.4095981768949],
                        [-2.372388619083221, 53.40952876960275],
                        [-2.372366986029961, 53.40974214341905],
                        [-2.37244330450709, 53.40977355411032],
                        [-2.3724480893933726, 53.40980293194619],
                        [-2.3730546640198655, 53.40984058711081],
                        [-2.3730816588728425, 53.409842195613976],
                        [-2.373519931021509, 53.40988946797718],
                        [-2.3736042816221192, 53.409901787986364],
                        [-2.3736898279409133, 53.40970736641803],
                        [-2.373605477415186, 53.40969504659278]
                    ]
                ]
            ],
            "type": "MultiPolygon"}
        """
        location.geom = GEOSGeometry(geometry, srid=4326)
        location.point = location.geom.centroid
        location.nearest_busstop = busstop
        location.save()

        self.assertIsNotNone(location.nearest_busstop)

        busstop.delete()

        changed_location = Location.objects.first()
        self.assertIsNone(changed_location.nearest_busstop)
        self.assertEqual(changed_location.nearest_busstop_distance, 0)

    @pytest.mark.django_db
    def test_trainstop_pre_delete_signal(self):
        trainstop = TrainStop()
        trainstop.name = 'Test TrainStop'
        trainstop.point = Point(-2.347743000012108, 53.38737090322739)
        trainstop.save()

        location = Location()
        location.name = 'Test Location'
        geometry = """
            {"coordinates": [
                [
                    [
                        [-2.373605477415186, 53.40969504659278],
                        [-2.3737618172100063, 53.409339507361864],
                        [-2.3736420825281206, 53.409349059663356],
                        [-2.3736136182503316, 53.40925098435937],
                        [-2.372348437061216, 53.40941673318565],
                        [-2.3723238976272407, 53.409362878222495],
                        [-2.371773640845859, 53.40943257437743],
                        [-2.3718032009919567, 53.40951191448939],
                        [-2.3718245008682466, 53.40956909854221],
                        [-2.3718353336832725, 53.4095981768949],
                        [-2.372388619083221, 53.40952876960275],
                        [-2.372366986029961, 53.40974214341905],
                        [-2.37244330450709, 53.40977355411032],
                        [-2.3724480893933726, 53.40980293194619],
                        [-2.3730546640198655, 53.40984058711081],
                        [-2.3730816588728425, 53.409842195613976],
                        [-2.373519931021509, 53.40988946797718],
                        [-2.3736042816221192, 53.409901787986364],
                        [-2.3736898279409133, 53.40970736641803],
                        [-2.373605477415186, 53.40969504659278]
                    ]
                ]
            ],
            "type": "MultiPolygon"}
        """
        location.geom = GEOSGeometry(geometry, srid=4326)
        location.point = location.geom.centroid
        location.nearest_trainstop = trainstop
        location.save()

        self.assertIsNotNone(location.nearest_trainstop)

        trainstop.delete()

        changed_location = Location.objects.first()
        self.assertIsNone(changed_location.nearest_trainstop)
        self.assertEqual(changed_location.nearest_trainstop_distance, 0)

    @pytest.mark.django_db
    def test_update_nearest_trainstop_on_new_location(self):
        trainstop = TrainStop()
        trainstop.name = 'Test TrainStop'
        trainstop.point = Point(-2.4153695332751557, 53.585971152959274)
        trainstop.save()

        location = Location()
        location.name = 'Test Location'
        geometry = """
            {"coordinates": [
                [
                    [
                        [-2.417243587559938, 53.587307594998805],
                        [-2.4172773190316676, 53.587280070692486],
                        [-2.4173514409852657, 53.58721825948106],
                        [-2.4173514409852657, 53.58721825948106],
                        [-2.417384428573676, 53.58719109717106],
                        [-2.417386408047504, 53.58718974239604],
                        [-2.417388763821763, 53.58718865588064],
                        [-2.417391496782378, 53.58718792747945],
                        [-2.417394356948235, 53.58718746820736],
                        [-2.417397345205334, 53.587187367918965],
                        [-2.417400337006054, 53.587187627048955],
                        [-2.4174030832552806, 53.587188246466916],
                        [-2.4174057076147375, 53.58718913588342],
                        [-2.4174557446310443, 53.587211066209946],
                        [-2.417457873460361, 53.587212226928386],
                        [-2.4174596313048182, 53.587213658515026],
                        [-2.417460892730692, 53.58721527155018],
                        [-2.417461656851856, 53.58721697617914],
                        [-2.417461798234508, 53.58721868298221],
                        [-2.417461442312349, 53.587220481379084],
                        [-2.4174603373317, 53.587222102675575],
                        [-2.4174588578217557, 53.58722363542186],
                        [-2.417425864940114, 53.58725025862445],
                        [-2.417425864940114, 53.58725025862445],
                        [-2.4173494967466667, 53.58731162843292],
                        [-2.4173157608682145, 53.58733870348632],
                        [-2.4173137804994558, 53.58733996840554],
                        [-2.4173114247148657, 53.58734105491944],
                        [-2.4173088162910576, 53.58734178288413],
                        [-2.417305956113853, 53.58734224215419],
                        [-2.4173029678456346, 53.58734234244034],
                        [-2.4173001005826373, 53.58734208287329],
                        [-2.417297355210633, 53.58734155330762],
                        [-2.417294730843975, 53.58734066388879],
                        [-2.417246949791007, 53.58732016334699],
                        [-2.417244820961996, 53.58731900262481],
                        [-2.4172429385723864, 53.58731757146959],
                        [-2.4172416771517287, 53.58731595843215],
                        [-2.417240913037613, 53.587314253801786],
                        [-2.41724077166351, 53.58731254699851],
                        [-2.4172411275957963, 53.587310748602285],
                        [-2.417242107153561, 53.58730903788777],
                        [-2.417243587559938, 53.587307594998805]
                    ]
                ]
            ],
            "type": "MultiPolygon"}
        """

        location.geom = GEOSGeometry(geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        saved_location = Location.objects.first()

        self.assertIsNotNone(saved_location.nearest_trainstop)
        self.assertTrue(saved_location.nearest_trainstop_distance > 0)

    @pytest.mark.django_db
    def test_substation_pre_delete_signal(self):
        substation = Substation()
        substation.name = 'Test Substation'
        substation_geometry = """
            {
                "type": "Polygon",
                "coordinates": [
                    [
                        [-2.169156312672857, 53.52891295465354],
                        [-2.1687144237941136, 53.52894144385621],
                        [-2.168797075718808, 53.529429845087705],
                        [-2.1686500332151675, 53.52944038951054],
                        [-2.1684401411007515, 53.52938945208653],
                        [-2.168404664180413, 53.5291931061935],
                        [-2.166117490672716, 53.52933158537432],
                        [-2.1657496762207225, 53.52920850645722],
                        [-2.1653364214890005, 53.529231100974236],
                        [-2.165305463631339, 53.529029354883946],
                        [-2.1653879841876353, 53.52891418943044],
                        [-2.1652921698108583, 53.52832828019789],
                        [-2.1690248562994463, 53.52810283893536],
                        [-2.169156312672857, 53.52891295465354]
                    ]
                ]
            }
        """
        substation.geom = GEOSGeometry(substation_geometry, srid=4326)
        substation.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "type": "MultiPolygon",
                "coordinates": [
                    [
                        [
                            [-2.157510776982608, 53.53674337389424],
                            [-2.1576731902784423, 53.53659844690615],
                            [-2.1577100338295208, 53.53656559076049],
                            [-2.1578566632695027, 53.536436863459144],
                            [-2.1577244610203583, 53.53638805160591],
                            [-2.1576149192450824, 53.536346849754615],
                            [-2.157513689675809, 53.53630923221811],
                            [-2.1574079353831115, 53.53627207010766],
                            [-2.157305202133001, 53.536235802644896],
                            [-2.157215308950556, 53.5362035628668],
                            [-2.1568762394878354, 53.53651815210801],
                            [-2.1569865252411087, 53.5365566571204],
                            [-2.1570915272990887, 53.53659427013797],
                            [-2.1571935067042554, 53.53663053877505],
                            [-2.1572969967274553, 53.536667254633834],
                            [-2.1574042623558207, 53.536704864394146],
                            [-2.157510776982608, 53.53674337389424]
                        ]
                    ]
                ]
            }
        """
        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        substation.update_close_locations(default_range=3000)
        changed_location = Location.objects.first()
        self.assertIsNotNone(changed_location.nearest_substation)

        substation.delete()

        changed_location = Location.objects.first()
        self.assertIsNone(changed_location.nearest_substation)
        self.assertEqual(changed_location.nearest_substation_distance, 0)

    @pytest.mark.django_db
    def test_update_nearest_substation_on_new_location(self):
        substation = Substation()
        substation.name = 'Test Substation'
        substation_geometry = """
            {
                "type": "Polygon",
                "coordinates": [
                    [
                        [-2.169156312672857, 53.52891295465354],
                        [-2.1687144237941136, 53.52894144385621],
                        [-2.168797075718808, 53.529429845087705],
                        [-2.1686500332151675, 53.52944038951054],
                        [-2.1684401411007515, 53.52938945208653],
                        [-2.168404664180413, 53.5291931061935],
                        [-2.166117490672716, 53.52933158537432],
                        [-2.1657496762207225, 53.52920850645722],
                        [-2.1653364214890005, 53.529231100974236],
                        [-2.165305463631339, 53.529029354883946],
                        [-2.1653879841876353, 53.52891418943044],
                        [-2.1652921698108583, 53.52832828019789],
                        [-2.1690248562994463, 53.52810283893536],
                        [-2.169156312672857, 53.52891295465354]
                    ]
                ]
            }
        """
        substation.geom = GEOSGeometry(substation_geometry, srid=4326)
        substation.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "type": "MultiPolygon",
                "coordinates": [
                    [
                        [
                            [-2.157510776982608, 53.53674337389424],
                            [-2.1576731902784423, 53.53659844690615],
                            [-2.1577100338295208, 53.53656559076049],
                            [-2.1578566632695027, 53.536436863459144],
                            [-2.1577244610203583, 53.53638805160591],
                            [-2.1576149192450824, 53.536346849754615],
                            [-2.157513689675809, 53.53630923221811],
                            [-2.1574079353831115, 53.53627207010766],
                            [-2.157305202133001, 53.536235802644896],
                            [-2.157215308950556, 53.5362035628668],
                            [-2.1568762394878354, 53.53651815210801],
                            [-2.1569865252411087, 53.5365566571204],
                            [-2.1570915272990887, 53.53659427013797],
                            [-2.1571935067042554, 53.53663053877505],
                            [-2.1572969967274553, 53.536667254633834],
                            [-2.1574042623558207, 53.536704864394146],
                            [-2.157510776982608, 53.53674337389424]
                        ]
                    ]
                ]
            }
        """
        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        saved_location = Location.objects.first()

        self.assertIsNotNone(saved_location.nearest_substation)
        self.assertTrue(saved_location.nearest_substation_distance > 0)

    @pytest.mark.django_db
    def test_update_nearest_overheadline_on_new_location(self):
        ohl = OverheadLine()
        ohl.gdo_gid = '12345678'
        ohl_geometry = """
            {
                "type": "LineString",
                "coordinates":
                    [
                        [-2.373197446341212, 53.435409941817795],
                        [-2.3750377532284324, 53.43243794909445],
                        [-2.376610485110038, 53.429871256256185],
                        [-2.378316153812549, 53.42704345147863]
                    ]
            }
        """
        ohl.geom = GEOSGeometry(ohl_geometry, srid=4326)
        ohl.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "type": "MultiPolygon",
                "coordinates":
                    [
                        [
                            [
                                [-2.373605477415186, 53.40969504659278],
                                [-2.3737618172100063, 53.409339507361864],
                                [-2.3736420825281206, 53.409349059663356],
                                [-2.3736136182503316, 53.40925098435937],
                                [-2.372348437061216, 53.40941673318565],
                                [-2.3723238976272407, 53.409362878222495],
                                [-2.371773640845859, 53.40943257437743],
                                [-2.3718032009919567, 53.40951191448939],
                                [-2.3718245008682466, 53.40956909854221],
                                [-2.3718353336832725, 53.4095981768949],
                                [-2.372388619083221, 53.40952876960275],
                                [-2.372366986029961, 53.40974214341905],
                                [-2.37244330450709, 53.40977355411032],
                                [-2.3724480893933726, 53.40980293194619],
                                [-2.3730546640198655, 53.40984058711081],
                                [-2.3730816588728425, 53.409842195613976],
                                [-2.373519931021509, 53.40988946797718],
                                [-2.3736042816221192, 53.409901787986364],
                                [-2.3736898279409133, 53.40970736641803],
                                [-2.373605477415186, 53.40969504659278]
                            ]
                        ]
                    ]
            }
        """

        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        saved_location = Location.objects.first()

        self.assertIsNotNone(saved_location.nearest_ohl)
        self.assertTrue(saved_location.nearest_ohl_distance > 0)

    @pytest.mark.django_db
    def test_overheadline_pre_delete_signal(self):
        ohl = OverheadLine()
        ohl.gdo_gid = '12345678'
        ohl_geometry = """
            {
                "type": "LineString",
                "coordinates":
                    [
                        [-2.373197446341212, 53.435409941817795],
                        [-2.3750377532284324, 53.43243794909445],
                        [-2.376610485110038, 53.429871256256185],
                        [-2.378316153812549, 53.42704345147863]
                    ]
            }
        """
        ohl.geom = GEOSGeometry(ohl_geometry, srid=4326)
        ohl.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "type": "MultiPolygon",
                "coordinates":
                    [
                        [
                            [
                                [-2.373605477415186, 53.40969504659278],
                                [-2.3737618172100063, 53.409339507361864],
                                [-2.3736420825281206, 53.409349059663356],
                                [-2.3736136182503316, 53.40925098435937],
                                [-2.372348437061216, 53.40941673318565],
                                [-2.3723238976272407, 53.409362878222495],
                                [-2.371773640845859, 53.40943257437743],
                                [-2.3718032009919567, 53.40951191448939],
                                [-2.3718245008682466, 53.40956909854221],
                                [-2.3718353336832725, 53.4095981768949],
                                [-2.372388619083221, 53.40952876960275],
                                [-2.372366986029961, 53.40974214341905],
                                [-2.37244330450709, 53.40977355411032],
                                [-2.3724480893933726, 53.40980293194619],
                                [-2.3730546640198655, 53.40984058711081],
                                [-2.3730816588728425, 53.409842195613976],
                                [-2.373519931021509, 53.40988946797718],
                                [-2.3736042816221192, 53.409901787986364],
                                [-2.3736898279409133, 53.40970736641803],
                                [-2.373605477415186, 53.40969504659278]
                            ]
                        ]
                    ]
            }
        """
        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.nearest_ohl = ohl
        location.save()

        self.assertIsNotNone(location.nearest_ohl)

        ohl.delete()

        changed_location = Location.objects.first()
        self.assertIsNone(changed_location.nearest_ohl)
        self.assertEqual(changed_location.nearest_ohl_distance, 0)

    @pytest.mark.django_db
    def test_motorway_pre_delete_signal(self):
        mw = Motorway()
        mw.identifier = '481e5ca4-97ce-459d-9838-f9f7ed91cc23'
        mw.number = 'M602 J2'
        mw_geometry = """
            {
                "coordinates": [-2.3375079500053952, 53.48588849626188],
                "type": "Point"
            }
        """
        mw.point = GEOSGeometry(mw_geometry, srid=4326)
        mw.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "coordinates":
                    [
                        [
                            [
                                [-2.3369972908395775, 53.48525888376972],
                                [-2.3369940525163266, 53.485268600458234],
                                [-2.336935498349989, 53.485296180508946],
                                [-2.3367903463184074, 53.485368677477894],
                                [-2.336774520316335, 53.485368362567186],
                                [-2.336019711835142, 53.48535538800574],
                                [-2.336016697902087, 53.48535539648553],
                                [-2.3359549016132783, 53.485354222063876],
                                [-2.3359283662457724, 53.485333623218004],
                                [-2.335851848827811, 53.485281255855334],
                                [-2.3358312496805573, 53.48526810072648],
                                [-2.335833954786922, 53.48517182657608],
                                [-2.3358419150472844, 53.48507311075863],
                                [-2.3358491446020144, 53.484958217742054],
                                [-2.33585832753517, 53.48482354458801],
                                [-2.3360229409259032, 53.48473472485203],
                                [-2.336061209496561, 53.48473362844167],
                                [-2.3361374658646623, 53.48473404303164],
                                [-2.3361510283650366, 53.48473400485853],
                                [-2.336232396964968, 53.48473296684289],
                                [-2.3362443004033504, 53.4847327535605],
                                [-2.3365771587847135, 53.48472858010187],
                                [-2.3367945937329364, 53.48472580988856],
                                [-2.3368375380765944, 53.48472523935196],
                                [-2.3368800877393925, 53.48475091625677],
                                [-2.336964126653662, 53.484801553934766],
                                [-2.3369762392572246, 53.484808710537855],
                                [-2.336985021610245, 53.484813988957036],
                                [-2.336986536399243, 53.48481497341494],
                                [-2.3369877540762216, 53.48481649801961],
                                [-2.336988364696983, 53.48481748502874],
                                [-2.336988528936734, 53.48481919237533],
                                [-2.3369883846580577, 53.484820001745085],
                                [-2.336987790433828, 53.484821082038614],
                                [-2.336987193357997, 53.48482180280125],
                                [-2.3369984958130687, 53.484897813396174],
                                [-2.336997444481465, 53.485202255955684],
                                [-2.3369972908395775, 53.48525888376972]
                            ]
                        ]
                    ],
                "type": "MultiPolygon"
            }
        """
        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.nearest_motorway = mw
        location.save()

        self.assertIsNotNone(location.nearest_motorway)

        mw.delete()

        changed_location = Location.objects.first()
        self.assertIsNone(changed_location.nearest_motorway)
        self.assertEqual(changed_location.nearest_motorway_distance, 0)

    @pytest.mark.django_db
    def test_update_nearest_motorway_on_new_location(self):
        mw = Motorway()
        mw.identifier = '481e5ca4-97ce-459d-9838-f9f7ed91cc23'
        mw.number = 'M602 J2'
        mw_geometry = """
            {
                "coordinates": [-2.3375079500053952, 53.48588849626188],
                "type": "Point"
            }
        """
        mw.point = GEOSGeometry(mw_geometry, srid=4326)
        mw.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "coordinates":
                    [
                        [
                            [
                                [-2.3369972908395775, 53.48525888376972],
                                [-2.3369940525163266, 53.485268600458234],
                                [-2.336935498349989, 53.485296180508946],
                                [-2.3367903463184074, 53.485368677477894],
                                [-2.336774520316335, 53.485368362567186],
                                [-2.336019711835142, 53.48535538800574],
                                [-2.336016697902087, 53.48535539648553],
                                [-2.3359549016132783, 53.485354222063876],
                                [-2.3359283662457724, 53.485333623218004],
                                [-2.335851848827811, 53.485281255855334],
                                [-2.3358312496805573, 53.48526810072648],
                                [-2.335833954786922, 53.48517182657608],
                                [-2.3358419150472844, 53.48507311075863],
                                [-2.3358491446020144, 53.484958217742054],
                                [-2.33585832753517, 53.48482354458801],
                                [-2.3360229409259032, 53.48473472485203],
                                [-2.336061209496561, 53.48473362844167],
                                [-2.3361374658646623, 53.48473404303164],
                                [-2.3361510283650366, 53.48473400485853],
                                [-2.336232396964968, 53.48473296684289],
                                [-2.3362443004033504, 53.4847327535605],
                                [-2.3365771587847135, 53.48472858010187],
                                [-2.3367945937329364, 53.48472580988856],
                                [-2.3368375380765944, 53.48472523935196],
                                [-2.3368800877393925, 53.48475091625677],
                                [-2.336964126653662, 53.484801553934766],
                                [-2.3369762392572246, 53.484808710537855],
                                [-2.336985021610245, 53.484813988957036],
                                [-2.336986536399243, 53.48481497341494],
                                [-2.3369877540762216, 53.48481649801961],
                                [-2.336988364696983, 53.48481748502874],
                                [-2.336988528936734, 53.48481919237533],
                                [-2.3369883846580577, 53.484820001745085],
                                [-2.336987790433828, 53.484821082038614],
                                [-2.336987193357997, 53.48482180280125],
                                [-2.3369984958130687, 53.484897813396174],
                                [-2.336997444481465, 53.485202255955684],
                                [-2.3369972908395775, 53.48525888376972]
                            ]
                        ]
                    ],
                "type": "MultiPolygon"
            }
        """
        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        saved_location = Location.objects.first()

        self.assertIsNotNone(saved_location.nearest_motorway)
        self.assertTrue(saved_location.nearest_motorway_distance > 0)


class TestTrainStopModel(TestCase):
    @pytest.mark.django_db
    def test_update_location_no_trainstop(self):
        trainstop = TrainStop()
        trainstop.name = 'Test TrainStop'
        trainstop.point = Point(-2.347743000012108, 53.38737090322739)
        trainstop.save()

        location = Location()
        location.name = 'Test Location'
        geometry = """
            {"coordinates": [
                [
                    [
                        [-2.373605477415186, 53.40969504659278],
                        [-2.3737618172100063, 53.409339507361864],
                        [-2.3736420825281206, 53.409349059663356],
                        [-2.3736136182503316, 53.40925098435937],
                        [-2.372348437061216, 53.40941673318565],
                        [-2.3723238976272407, 53.409362878222495],
                        [-2.371773640845859, 53.40943257437743],
                        [-2.3718032009919567, 53.40951191448939],
                        [-2.3718245008682466, 53.40956909854221],
                        [-2.3718353336832725, 53.4095981768949],
                        [-2.372388619083221, 53.40952876960275],
                        [-2.372366986029961, 53.40974214341905],
                        [-2.37244330450709, 53.40977355411032],
                        [-2.3724480893933726, 53.40980293194619],
                        [-2.3730546640198655, 53.40984058711081],
                        [-2.3730816588728425, 53.409842195613976],
                        [-2.373519931021509, 53.40988946797718],
                        [-2.3736042816221192, 53.409901787986364],
                        [-2.3736898279409133, 53.40970736641803],
                        [-2.373605477415186, 53.40969504659278]
                    ]
                ]
            ],
            "type": "MultiPolygon"}
        """
        location.geom = GEOSGeometry(geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        trainstop.update_close_locations(default_range=3000)

        updated_location = Location.objects.first()
        self.assertEqual(
            updated_location.nearest_trainstop.name,
            'Test TrainStop')
        self.assertIsNotNone(updated_location.nearest_trainstop_distance)


class TestSubstationModel(TestCase):
    @pytest.mark.django_db
    def test_update_location_no_substation(self):
        substation = Substation()
        substation.name = 'Test Substation'
        substation_geometry = """
            {
                "type": "Polygon",
                "coordinates": [
                    [
                        [-2.169156312672857, 53.52891295465354],
                        [-2.1687144237941136, 53.52894144385621],
                        [-2.168797075718808, 53.529429845087705],
                        [-2.1686500332151675, 53.52944038951054],
                        [-2.1684401411007515, 53.52938945208653],
                        [-2.168404664180413, 53.5291931061935],
                        [-2.166117490672716, 53.52933158537432],
                        [-2.1657496762207225, 53.52920850645722],
                        [-2.1653364214890005, 53.529231100974236],
                        [-2.165305463631339, 53.529029354883946],
                        [-2.1653879841876353, 53.52891418943044],
                        [-2.1652921698108583, 53.52832828019789],
                        [-2.1690248562994463, 53.52810283893536],
                        [-2.169156312672857, 53.52891295465354]
                    ]
                ]
            }
        """
        substation.geom = GEOSGeometry(substation_geometry, srid=4326)
        substation.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "type": "MultiPolygon",
                "coordinates": [
                    [
                        [
                            [-2.157510776982608, 53.53674337389424],
                            [-2.1576731902784423, 53.53659844690615],
                            [-2.1577100338295208, 53.53656559076049],
                            [-2.1578566632695027, 53.536436863459144],
                            [-2.1577244610203583, 53.53638805160591],
                            [-2.1576149192450824, 53.536346849754615],
                            [-2.157513689675809, 53.53630923221811],
                            [-2.1574079353831115, 53.53627207010766],
                            [-2.157305202133001, 53.536235802644896],
                            [-2.157215308950556, 53.5362035628668],
                            [-2.1568762394878354, 53.53651815210801],
                            [-2.1569865252411087, 53.5365566571204],
                            [-2.1570915272990887, 53.53659427013797],
                            [-2.1571935067042554, 53.53663053877505],
                            [-2.1572969967274553, 53.536667254633834],
                            [-2.1574042623558207, 53.536704864394146],
                            [-2.157510776982608, 53.53674337389424]
                        ]
                    ]
                ]
            }
        """
        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        substation.update_close_locations(default_range=3000)

        updated_location = Location.objects.first()
        self.assertEqual(
            updated_location.nearest_substation.name,
            'Test Substation')
        self.assertIsNotNone(updated_location.nearest_substation_distance)


class TestOverheadLineModel(TestCase):
    @pytest.mark.django_db
    def test_update_location_no_overheadline(self):
        ohl = OverheadLine()
        ohl.gdo_gid = '12345678'
        ohl_geometry = """
            {
                "type": "LineString",
                "coordinates":
                    [
                        [-2.373197446341212, 53.435409941817795],
                        [-2.3750377532284324, 53.43243794909445],
                        [-2.376610485110038, 53.429871256256185],
                        [-2.378316153812549, 53.42704345147863]
                    ]
            }
        """
        ohl.geom = GEOSGeometry(ohl_geometry, srid=4326)
        ohl.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "type": "MultiPolygon",
                "coordinates":
                    [
                        [
                            [
                                [-2.373605477415186, 53.40969504659278],
                                [-2.3737618172100063, 53.409339507361864],
                                [-2.3736420825281206, 53.409349059663356],
                                [-2.3736136182503316, 53.40925098435937],
                                [-2.372348437061216, 53.40941673318565],
                                [-2.3723238976272407, 53.409362878222495],
                                [-2.371773640845859, 53.40943257437743],
                                [-2.3718032009919567, 53.40951191448939],
                                [-2.3718245008682466, 53.40956909854221],
                                [-2.3718353336832725, 53.4095981768949],
                                [-2.372388619083221, 53.40952876960275],
                                [-2.372366986029961, 53.40974214341905],
                                [-2.37244330450709, 53.40977355411032],
                                [-2.3724480893933726, 53.40980293194619],
                                [-2.3730546640198655, 53.40984058711081],
                                [-2.3730816588728425, 53.409842195613976],
                                [-2.373519931021509, 53.40988946797718],
                                [-2.3736042816221192, 53.409901787986364],
                                [-2.3736898279409133, 53.40970736641803],
                                [-2.373605477415186, 53.40969504659278]
                            ]
                        ]
                    ]
            }
        """
        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        ohl.update_close_locations(default_range=3000)

        updated_location = Location.objects.first()
        self.assertEqual(updated_location.nearest_ohl.gdo_gid, '12345678')
        self.assertIsNotNone(updated_location.nearest_ohl_distance)


class TestMotorwayModel(TestCase):
    @pytest.mark.django_db
    def test_update_location_no_motorway(self):
        mw = Motorway()
        mw.identifier = '481e5ca4-97ce-459d-9838-f9f7ed91cc23'
        mw.number = 'M602 J2'
        mw_geometry = """
            {
                "coordinates": [-2.3375079500053952, 53.48588849626188],
                "type": "Point"
            }
        """
        mw.point = GEOSGeometry(mw_geometry, srid=4326)
        mw.save()

        location = Location()
        location.name = 'Test Location'
        location_geometry = """
            {
                "coordinates":
                    [
                        [
                            [
                                [-2.3369972908395775, 53.48525888376972],
                                [-2.3369940525163266, 53.485268600458234],
                                [-2.336935498349989, 53.485296180508946],
                                [-2.3367903463184074, 53.485368677477894],
                                [-2.336774520316335, 53.485368362567186],
                                [-2.336019711835142, 53.48535538800574],
                                [-2.336016697902087, 53.48535539648553],
                                [-2.3359549016132783, 53.485354222063876],
                                [-2.3359283662457724, 53.485333623218004],
                                [-2.335851848827811, 53.485281255855334],
                                [-2.3358312496805573, 53.48526810072648],
                                [-2.335833954786922, 53.48517182657608],
                                [-2.3358419150472844, 53.48507311075863],
                                [-2.3358491446020144, 53.484958217742054],
                                [-2.33585832753517, 53.48482354458801],
                                [-2.3360229409259032, 53.48473472485203],
                                [-2.336061209496561, 53.48473362844167],
                                [-2.3361374658646623, 53.48473404303164],
                                [-2.3361510283650366, 53.48473400485853],
                                [-2.336232396964968, 53.48473296684289],
                                [-2.3362443004033504, 53.4847327535605],
                                [-2.3365771587847135, 53.48472858010187],
                                [-2.3367945937329364, 53.48472580988856],
                                [-2.3368375380765944, 53.48472523935196],
                                [-2.3368800877393925, 53.48475091625677],
                                [-2.336964126653662, 53.484801553934766],
                                [-2.3369762392572246, 53.484808710537855],
                                [-2.336985021610245, 53.484813988957036],
                                [-2.336986536399243, 53.48481497341494],
                                [-2.3369877540762216, 53.48481649801961],
                                [-2.336988364696983, 53.48481748502874],
                                [-2.336988528936734, 53.48481919237533],
                                [-2.3369883846580577, 53.484820001745085],
                                [-2.336987790433828, 53.484821082038614],
                                [-2.336987193357997, 53.48482180280125],
                                [-2.3369984958130687, 53.484897813396174],
                                [-2.336997444481465, 53.485202255955684],
                                [-2.3369972908395775, 53.48525888376972]
                            ]
                        ]
                    ],
                "type": "MultiPolygon"
            }
        """
        location.geom = GEOSGeometry(location_geometry, srid=4326)
        location.point = location.geom.centroid
        location.save()

        mw.update_close_locations(default_range=3000)

        updated_location = Location.objects.first()
        self.assertEqual(
            updated_location.nearest_motorway.identifier,
            '481e5ca4-97ce-459d-9838-f9f7ed91cc23')
        self.assertIsNotNone(updated_location.nearest_motorway_distance)
